import { deepStrictEqual } from "assert";
import { webcrypto } from "crypto";

import webauthPublicKey from "../src/_utils/webauthn-public-key.js";

it("webauth public_keys", async () => {
  const clientDataJSON = Uint8Array.from([
    123, 34, 116, 121, 112, 101, 34, 58, 34, 119, 101, 98, 97, 117, 116, 104,
    110, 46, 99, 114, 101, 97, 116, 101, 34, 44, 34, 99, 104, 97, 108, 108, 101,
    110, 103, 101, 34, 58, 34, 103, 109, 53, 51, 102, 118, 102, 104, 88, 114,
    73, 80, 114, 49, 81, 119, 111, 70, 121, 103, 98, 118, 121, 115, 49, 70, 81,
    55, 104, 72, 86, 98, 56, 75, 107, 52, 56, 83, 113, 120, 80, 54, 52, 34, 44,
    34, 111, 114, 105, 103, 105, 110, 34, 58, 34, 104, 116, 116, 112, 115, 58,
    47, 47, 119, 101, 98, 97, 117, 116, 104, 46, 99, 111, 109, 34, 44, 34, 99,
    114, 111, 115, 115, 79, 114, 105, 103, 105, 110, 34, 58, 102, 97, 108, 115,
    101, 125,
  ]).buffer;

  const attestationObject = Uint8Array.from([
    163, 99, 102, 109, 116, 100, 110, 111, 110, 101, 103, 97, 116, 116, 83, 116,
    109, 116, 160, 104, 97, 117, 116, 104, 68, 97, 116, 97, 88, 164, 35, 170,
    155, 217, 51, 14, 35, 138, 106, 223, 213, 96, 26, 73, 92, 62, 7, 157, 140,
    122, 125, 7, 209, 133, 166, 116, 156, 52, 108, 166, 151, 191, 69, 0, 0, 0,
    0, 173, 206, 0, 2, 53, 188, 198, 10, 100, 139, 11, 37, 241, 240, 85, 3, 0,
    32, 11, 194, 92, 201, 199, 149, 79, 54, 143, 48, 113, 185, 156, 192, 195,
    83, 115, 228, 104, 232, 241, 231, 56, 0, 193, 219, 154, 177, 25, 194, 118,
    31, 165, 1, 2, 3, 38, 32, 1, 33, 88, 32, 46, 175, 195, 31, 30, 152, 18, 7,
    50, 106, 73, 28, 200, 200, 78, 121, 215, 10, 225, 145, 164, 172, 28, 84,
    166, 127, 83, 168, 146, 180, 46, 76, 34, 88, 32, 234, 170, 15, 21, 186, 187,
    173, 233, 66, 130, 130, 59, 116, 199, 229, 24, 138, 136, 139, 48, 183, 214,
    155, 73, 166, 58, 62, 58, 247, 237, 98, 90,
  ]).buffer;

  // Add this to simulate browser environment for window.
  global.window = {
    crypto: {
      subtle: webcrypto.subtle,
    },
  };

  deepStrictEqual(
    await webauthPublicKey({ attestationObject, clientDataJSON }),
    "PUB_WA_2ZTU7dUiALKzd4CXXRzAqtmzvP9N9873VEgUhwFajs2BFZXSSL6Eu3Y3mUrm59Mf9MC9"
  );
  delete global.window;
});
